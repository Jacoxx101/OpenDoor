<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --border: #e5e7eb;
            --text: #000000;
            --text-light: #666666;
            --primary: #000000;
            --primary-hover: #333333;
            --input-bg: #f9fafb;
            --message-bg: #f9fafb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg);
        }

        .title {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .api-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text-light);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .api-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .api-btn.connected {
            color: #059669;
            border-color: #059669;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1.5rem;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: var(--text);
            color: white;
        }

        .message.assistant .avatar {
            background: var(--message-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .message-content {
            flex: 1;
            line-height: 1.3;
        }

        /* Markdown styling for AI responses */
        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin: 1rem 0 0.5rem 0;
            color: var(--text);
        }

        .message-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 2px solid var(--text);
            padding-bottom: 0.5rem;
            margin: 1.5rem 0 1rem 0;
            color: var(--text);
        }

        .message-content h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin: 1.25rem 0 0.75rem 0;
            padding: 0.5rem 0;
            border-left: 4px solid var(--text);
            padding-left: 1rem;
        }

        .message-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: var(--text);
        }

        .message-content strong {
            font-weight: 700;
            color: var(--text);
            background: rgba(0, 0, 0, 0.05);
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
        }

        .message-content em {
            font-style: italic;
            color: var(--text-light);
            background: rgba(102, 102, 102, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
        }

        .message-content hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
            width: 100%;
        }

        /* Recipe section styling */
        .message-content h2 + p,
        .message-content h2 + ul,
        .message-content h3 + p,
        .message-content h3 + ul {
            margin-top: 0.5rem;
        }

        /* Better paragraph spacing in recipe context */
        .message-content h3 + p + ul {
            margin-top: 0.75rem;
        }

        /* Nutritional highlight boxes */
        .message-content p:contains("Nutritional") {
            background: rgba(0, 0, 0, 0.02);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--text);
            margin: 1rem 0;
        }

        .message-content ul {
            margin: 0.75rem 0;
            padding-left: 0;
            list-style: none;
        }

        .message-content li {
            margin: 0.125rem 0;
            padding: 0 0 0 1.5rem;
            position: relative;
            line-height: 1.3;
        }

        .message-content li::before {
            content: "•";
            color: var(--text);
            font-weight: bold;
            position: absolute;
            left: 0.5rem;
        }

        .message-content ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
            list-style: decimal;
        }

        .message-content ol li {
            padding-left: 0.5rem;
            margin: 0.125rem 0;
            line-height: 1.3;
            list-style-type: decimal;
        }

        .message-content ol li::before {
            display: none;
        }

        .message-content p {
            margin: 0;
            line-height: 1.3;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Input Area */
        .input-container {
            padding: 1.5rem 0;
            border-top: 1px solid var(--border);
        }

        .input-form {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-textarea {
            width: 100%;
            min-height: 48px;
            max-height: 120px;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background: var(--input-bg);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.2s;
        }

        .input-textarea:focus {
            border-color: var(--primary);
            background: var(--bg);
        }

        .input-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--text);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--primary-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state p {
            margin-bottom: 2rem;
        }

        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            width: 100%;
            max-width: 600px;
        }

        .example {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--input-bg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .example h3 {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .example p {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .modal h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--input-bg);
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: var(--bg);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .form-help a {
            color: var(--primary);
            text-decoration: none;
        }

        .form-error {
            font-size: 0.75rem;
            color: #dc2626;
            margin-top: 0.25rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .loading {
            display: inline-flex;
            gap: 2px;
        }

        .loading-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-light);
            animation: loading 1.4s infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @media (max-width: 640px) {
            .header {
                padding: 1rem;
            }
            
            .chat-container {
                padding: 0 0.75rem;
            }
            
            .examples {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <h2>API Configuration</h2>
            <form id="apiForm">
                <div class="form-group">
                    <label class="form-label">Gemini API Key</label>
                    <input type="password" id="apiInput" class="form-input" placeholder="Enter your API key" required>
                    <div class="form-help">
                        Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                    </div>
                    <div class="form-error" id="apiError"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="title">AI Chat</div>
        <button class="api-btn" id="apiBtn">API Key</button>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="empty-state" id="emptyState">
                <h2>Welcome to AI Chat</h2>
                <p>Start a conversation with the AI assistant</p>
                <div class="examples">
                    <div class="example" data-prompt="Explain quantum computing simply">
                        <h3>Science</h3>
                        <p>Explain quantum computing simply</p>
                    </div>
                    <div class="example" data-prompt="Write a short story">
                        <h3>Creative</h3>
                        <p>Write a short story</p>
                    </div>
                    <div class="example" data-prompt="Plan a healthy meal">
                        <h3>Health</h3>
                        <p>Plan a healthy meal</p>
                    </div>
                    <div class="example" data-prompt="Solve: 2x + 5 = 15">
                        <h3>Math</h3>
                        <p>Solve: 2x + 5 = 15</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <form class="input-form" id="chatForm">
                <textarea 
                    class="input-textarea" 
                    id="messageInput" 
                    placeholder="Message AI Chat..." 
                    rows="1"
                    disabled
                ></textarea>
                <button type="submit" class="send-btn" id="sendBtn" disabled>
                    ↑
                </button>
            </form>
        </div>
    </div>

    <script>
        class MinimalChat {
            constructor() {
                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.messages = [];
                this.isLoading = false;
                
                this.initElements();
                this.bindEvents();
                this.updateUI();
                
                if (!this.apiKey) {
                    this.showModal();
                }
            }
            
            initElements() {
                this.apiModal = document.getElementById('apiModal');
                this.apiForm = document.getElementById('apiForm');
                this.apiInput = document.getElementById('apiInput');
                this.apiError = document.getElementById('apiError');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.apiBtn = document.getElementById('apiBtn');
                this.messagesEl = document.getElementById('messages');
                this.emptyState = document.getElementById('emptyState');
                this.chatForm = document.getElementById('chatForm');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.examples = document.querySelectorAll('.example');
            }
            
            bindEvents() {
                this.apiForm.addEventListener('submit', (e) => this.handleApiSubmit(e));
                this.cancelBtn.addEventListener('click', () => this.hideModal());
                this.apiBtn.addEventListener('click', () => this.showModal());
                this.chatForm.addEventListener('submit', (e) => this.handleChat(e));
                
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
                });
                
                this.examples.forEach(ex => {
                    ex.addEventListener('click', () => {
                        const prompt = ex.dataset.prompt;
                        this.messageInput.value = prompt;
                        setTimeout(() => this.chatForm.dispatchEvent(new Event('submit')), 100);
                    });
                });
                
                this.apiModal.addEventListener('click', (e) => {
                    if (e.target === this.apiModal) this.hideModal();
                });
            }
            
            updateUI() {
                const hasKey = !!this.apiKey;
                this.apiBtn.textContent = hasKey ? '✓ Connected' : 'API Key';
                this.apiBtn.classList.toggle('connected', hasKey);
                this.messageInput.disabled = !hasKey;
                this.sendBtn.disabled = !hasKey;
                this.messageInput.placeholder = hasKey ? 'Message AI Chat...' : 'Configure API key first';
            }
            
            showModal() {
                this.apiInput.value = this.apiKey;
                this.apiError.textContent = '';
                this.apiModal.classList.add('active');
                setTimeout(() => this.apiInput.focus(), 100);
            }
            
            hideModal() {
                this.apiModal.classList.remove('active');
            }
            
            async handleApiSubmit(e) {
                e.preventDefault();
                const key = this.apiInput.value.trim();
                
                if (!key) {
                    this.apiError.textContent = 'Please enter an API key';
                    return;
                }
                
                this.saveBtn.textContent = 'Testing...';
                this.saveBtn.disabled = true;
                
                try {
                    const valid = await this.testApiKey(key);
                    if (valid) {
                        this.apiKey = key;
                        localStorage.setItem('gemini_api_key', key);
                        this.updateUI();
                        this.hideModal();
                    } else {
                        this.apiError.textContent = 'Invalid API key';
                    }
                } catch {
                    this.apiError.textContent = 'Failed to validate key';
                } finally {
                    this.saveBtn.textContent = 'Save';
                    this.saveBtn.disabled = false;
                }
            }
            
            async testApiKey(key) {
                // Skip validation - just check if key format looks valid
                if (!key || key.length < 20) {
                    return false;
                }
                
                // Basic format check for Google API keys
                if (!key.startsWith('AIza') && !key.match(/^[A-Za-z0-9_-]+$/)) {
                    return false;
                }
                
                return true; // Accept the key and test it during first actual API call
            }
            
            async handleChat(e) {
                e.preventDefault();
                if (!this.apiKey || this.isLoading) return;
                
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                this.emptyState.style.display = 'none';
                this.addMessage(message, 'user');
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                
                this.showLoading();
                
                try {
                    const response = await this.sendToGemini(message);
                    this.hideLoading();
                    this.addMessage(response, 'assistant');
                } catch (error) {
                    this.hideLoading();
                    console.error('Chat error:', error);
                    
                    if (error.message.includes('Invalid API key') || error.message.includes('API_KEY_INVALID')) {
                        this.addMessage('❌ Invalid API key. Please click "API Key" to enter a valid key.', 'assistant');
                        // Clear the invalid key
                        this.apiKey = '';
                        localStorage.removeItem('gemini_api_key');
                        this.updateUI();
                    } else if (error.message.includes('Network error')) {
                        this.addMessage('🌐 Network error. Please check your internet connection and try again.', 'assistant');
                    } else if (error.message.includes('access denied')) {
                        this.addMessage('🔒 API access denied. Please check your API key permissions in Google AI Studio.', 'assistant');
                    } else {
                        this.addMessage(`❌ Error: ${error.message}`, 'assistant');
                    }
                }
            }
            
            async sendToGemini(message) {
                try {
                    console.log('Sending request to Gemini API...');
                    
                    const systemPrompt = "Format responses following ChatGPT's meal planning UI best practices: Use strategic emojis ONLY as visual anchors for main sections (## 🥗 Main Dish, ## 🥑 Side Dish, ## 📋 Instructions). Bold nutritional keywords (**protein**, **omega-3**, **complex carbs**). Structure: Header → Main content → Supporting details. Use * for ingredient lists, numbered lists for instructions. Add parenthetical context (like nutritional benefits). End with clear dividers --- between major sections. Keep design clean, scannable, and professional with logical information hierarchy.";
                    
                    const requestBody = {
                        contents: [{
                            parts: [{
                                text: systemPrompt + "\n\nUser question: " + message
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024,
                        }
                    };
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-goog-api-key': this.apiKey
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        
                        try {
                            const errorData = JSON.parse(errorText);
                            if (response.status === 400 && errorData.error?.message?.includes('API_KEY_INVALID')) {
                                throw new Error('Invalid API key. Please check your API key and try again.');
                            }
                            if (response.status === 403) {
                                throw new Error('API key access denied. Please check your API key permissions.');
                            }
                            throw new Error(`API Error: ${errorData.error?.message || response.status}`);
                        } catch (parseError) {
                            throw new Error(`API Error: ${response.status} - ${errorText}`);
                        }
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error('Invalid response from API');
                    }
                    
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        throw new Error('Network error. Please check your internet connection and try again.');
                    }
                    throw error;
                }
            }
            
            parseMarkdown(text) {
                let html = text
                    // Headers
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    
                    // Bold and Italic
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    
                    // Horizontal rules
                    .replace(/^---$/gm, '<hr>');

                // Handle lists with proper grouping
                const lines = html.split('\n');
                const result = [];
                let inOrderedList = false;
                let inUnorderedList = false;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Numbered list items
                    if (/^\d+\.\s/.test(line)) {
                        if (!inOrderedList) {
                            if (inUnorderedList) {
                                result.push('</ul>');
                                inUnorderedList = false;
                            }
                            result.push('<ol>');
                            inOrderedList = true;
                        }
                        const content = line.replace(/^\d+\.\s/, '');
                        result.push(`<li>${content}</li>`);
                    }
                    // Bullet list items
                    else if (/^\*\s/.test(line)) {
                        if (!inUnorderedList) {
                            if (inOrderedList) {
                                result.push('</ol>');
                                inOrderedList = false;
                            }
                            result.push('<ul>');
                            inUnorderedList = true;
                        }
                        const content = line.replace(/^\*\s/, '');
                        result.push(`<li>${content}</li>`);
                    }
                    // Regular content
                    else {
                        if (inOrderedList) {
                            result.push('</ol>');
                            inOrderedList = false;
                        }
                        if (inUnorderedList) {
                            result.push('</ul>');
                            inUnorderedList = false;
                        }
                        
                        if (line.trim() !== '') {
                            result.push(`<p>${line}</p>`);
                        }
                    }
                }

                // Close any open lists
                if (inOrderedList) result.push('</ol>');
                if (inUnorderedList) result.push('</ul>');

                return result.join('\n')
                    .replace(/<p><\/p>/g, '')
                    .replace(/<p>(<[h|u|o|h])/g, '$1')
                    .replace(/(<\/[h|u|o|h][^>]*>)<\/p>/g, '$1');
            }
            
            addMessage(text, role) {
                const div = document.createElement('div');
                div.className = `message ${role}`;
                
                const formattedText = role === 'assistant' ? this.parseMarkdown(text) : text;
                
                div.innerHTML = `
                    <div class="avatar">${role === 'user' ? 'U' : 'AI'}</div>
                    <div class="message-content">${formattedText}</div>
                `;
                this.messagesEl.appendChild(div);
                this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
            }
            
            showLoading() {
                this.isLoading = true;
                this.messageInput.disabled = true;
                this.sendBtn.disabled = true;
                
                const div = document.createElement('div');
                div.className = 'message assistant loading-msg';
                div.innerHTML = `
                    <div class="avatar">AI</div>
                    <div class="message-content">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                `;
                this.messagesEl.appendChild(div);
                this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
            }
            
            hideLoading() {
                this.isLoading = false;
                this.messageInput.disabled = !this.apiKey;
                this.sendBtn.disabled = !this.apiKey;
                
                const loading = this.messagesEl.querySelector('.loading-msg');
                if (loading) loading.remove();
            }
        }
        
        new MinimalChat();
    </script>
</body>
</html>