<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenDoor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --border: #e5e7eb;
            --text: #111111;
            --text-light: #666666;
            --primary: #000000;
            --primary-hover: #333333;
            --input-bg: #f0f0f0;
            --message-bg: #f9fafb;
        }

        [data-theme="dark"] {
            --bg: #212121;
            --border: #404040;
            --text: #ffffff;
            --text-light: #cccccc;
            --primary: #ffffff;
            --primary-hover: #cccccc;
            --input-bg: #2a2a2a;
            --message-bg: #2a2a2a;
            --sidebar-bg: #181818;
            --sidebar-border: #333333;
        }

        :root {
            --sidebar-bg: #f9fafb;
            --sidebar-border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        /* Header */
        .header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title {
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .title:hover {
            opacity: 0.7;
        }

        .logo {
            width: 34px;
            height: 34px;
            border-radius: 0.5rem;
            object-fit: cover;
        }

        .api-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text-light);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .api-btn:hover {
            border-color: var(--text);
            color: var(--text);
        }

        .api-btn.connected {
            color: #10b981;
            border-color: #10b981;
        }

        /* Model Selection */
        .model-selector {
            margin-right: 1rem;
            position: relative;
        }

        .model-select {
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text);
            font-size: 0.875rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
            min-width: 140px;
        }

        .model-select:hover {
            border-color: var(--text);
        }

        .model-select:focus {
            outline: none;
            border-color: var(--text);
            background: var(--bg);
        }

        .model-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
            display: block;
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            margin-right: 1rem;
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .theme-toggle:hover {
            border-color: var(--text);
            background: var(--input-bg);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 10;
        }

        [data-theme="dark"] .sidebar {
            background: #181818 !important;
            border-right: 1px solid #333333 !important;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--sidebar-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        [data-theme="dark"] .sidebar-header {
            border-bottom: 1px solid #333333 !important;
        }

        .new-chat-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--text);
            color: var(--sidebar-bg);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .new-chat-btn:hover {
            opacity: 0.9;
        }

        .sidebar-toggle {
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--sidebar-border);
            border-radius: 0.375rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-toggle:hover {
            background: var(--sidebar-bg);
            filter: brightness(0.95);
        }

        .search-container {
            padding: 1rem;
            border-bottom: 1px solid var(--sidebar-border);
        }

        [data-theme="dark"] .search-container {
            border-bottom: 1px solid #333333 !important;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
        }

        .search-input::placeholder {
            color: var(--text-light);
        }

        .search-input:focus {
            border-color: var(--text);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .chat-item {
            padding: 10px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-item:hover {
            background: var(--message-bg);
        }

        .chat-item.active {
            background: var(--text);
            color: var(--sidebar-bg);
        }

        .chat-item.active .chat-title {
            color: var(--sidebar-bg);
        }

        .chat-item.active .chat-date {
            color: var(--sidebar-bg);
            opacity: 0.8;
        }

        .chat-item.active .chat-menu-btn {
            color: var(--sidebar-bg);
        }

        .chat-title {
            font-size: 0.875rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            color: var(--text);
            line-height: 1.2;
        }

        .chat-date {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
            line-height: 1;
        }

        .chat-content {
            flex: 1;
            min-width: 0;
        }

        .chat-menu {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-item:hover .chat-menu {
            opacity: 1;
        }

        .chat-menu-btn {
            padding: 0.25rem;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .chat-menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Chat Menu Dropdown */
        .chat-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 120px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            transform: translateY(-10px);
        }

        .chat-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .chat-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .chat-dropdown-item:last-child {
            border-bottom: none;
        }

        .chat-dropdown-item:hover {
            background: var(--input-bg);
        }

        .chat-dropdown-item.danger {
            color: #dc2626;
        }

        .chat-dropdown-item.danger:hover {
            background: rgba(220, 38, 38, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1.5rem;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: var(--text);
            color: white;
        }

        .message.assistant .avatar {
            background: var(--message-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .message-content {
            flex: 1;
            line-height: 1.3;
            color: var(--text);
        }

        /* Markdown styling for AI responses */
        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin: 1rem 0 0.5rem 0;
            color: var(--text);
        }

        .message-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 2px solid var(--text);
            padding-bottom: 0.5rem;
            margin: 1.5rem 0 1rem 0;
            color: var(--text);
        }

        .message-content h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin: 1.25rem 0 0.75rem 0;
            padding: 0.5rem 0;
            border-left: 4px solid var(--text);
            padding-left: 1rem;
        }

        .message-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: var(--text);
        }

        .message-content strong {
            font-weight: 700;
            color: var(--text);
        }

        .message-content em {
            font-style: italic;
            color: var(--text);
        }

        .message-content hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
            width: 100%;
        }

        /* Code Blocks */
        .code-block {
            margin: 1rem 0;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            overflow: hidden;
            background: var(--input-bg);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--border);
            border-bottom: 1px solid var(--border);
        }

        .code-lang {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--input-bg);
            color: var(--text);
        }

        .code-block pre {
            margin: 0;
            padding: 1rem;
            overflow-x: auto;
            background: var(--input-bg);
        }

        .code-block code {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Inline Code */
        .inline-code {
            background: var(--input-bg);
            border: 1px solid var(--border);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        /* Blockquotes */
        .message-content blockquote {
            border-left: 4px solid var(--text);
            padding: 0.5rem 1rem;
            margin: 1rem 0;
            background: var(--input-bg);
            font-style: italic;
            color: var(--text-light);
        }

        /* Tables */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .message-content th,
        .message-content td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .message-content th {
            background: var(--input-bg);
            font-weight: 600;
            color: var(--text);
        }

        .message-content tr:last-child td {
            border-bottom: none;
        }

        /* Zebra only on tbody so the header styling remains clean */
        .message-content tbody tr:nth-child(even) {
            background: var(--input-bg);
        }

        .message-content td.center {
            text-align: center;
        }

        .message-content td.right {
            text-align: right;
        }

        /* Recipe section styling */
        .message-content h2 + p,
        .message-content h2 + ul,
        .message-content h3 + p,
        .message-content h3 + ul {
            margin-top: 0.5rem;
        }

        /* Better paragraph spacing in recipe context */
        .message-content h3 + p + ul {
            margin-top: 0.75rem;
        }


        .message-content ul {
            margin: 0.75rem 0;
            padding-left: 0;
            list-style: none;
        }

        .message-content li {
            margin: 0.125rem 0;
            padding: 0 0 0 1.5rem;
            position: relative;
            line-height: 1.3;
        }

        .message-content li::before {
            content: "•";
            color: var(--text);
            font-weight: bold;
            position: absolute;
            left: 0.5rem;
        }

        .message-content ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
            list-style: decimal;
        }

        .message-content ol li {
            padding-left: 0.5rem;
            margin: 0.125rem 0;
            line-height: 1.3;
            list-style-type: decimal;
        }

        .message-content ol li::before {
            display: none;
        }

        .message-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        /* Give a tiny gap between any two blocks for readability */
        .message-content > * + * {
            margin-top: 0.25rem;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Input Area */
        .input-container {
            padding: 1.5rem 0;
            border-top: 1px solid var(--border);
        }

        .input-form {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-textarea {
            width: 100%;
            min-height: 48px;
            max-height: 120px;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background: var(--input-bg);
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.2s;
        }

        .input-textarea::placeholder {
            color: var(--text-light);
        }

        .input-textarea:focus {
            border-color: var(--text);
            background: var(--bg);
        }

        .input-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--text);
            color: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            opacity: 0.9;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--border);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state p {
            margin-bottom: 2rem;
            color: var(--text);
        }

        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            width: 100%;
            max-width: 600px;
        }

        .example {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--input-bg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example:hover {
            border-color: var(--text);
            background: var(--bg);
        }

        .example h3 {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .example p {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .modal h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--input-bg);
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--text);
            background: var(--bg);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .form-help a {
            color: var(--text);
            text-decoration: none;
        }

        .form-error {
            font-size: 0.75rem;
            color: #dc2626;
            margin-top: 0.25rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-primary {
            background: var(--text);
            color: var(--bg);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .loading {
            display: inline-flex;
            gap: 2px;
        }

        .loading-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-light);
            animation: loading 1.4s infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar:not(.hidden) {
                transform: translateX(0);
            }

            .sidebar.hidden {
                transform: translateX(-100%);
            }

            .main-content {
                width: 100%;
            }

            .header {
                padding: 1rem;
            }

            .header-left {
                gap: 0.5rem;
            }

            .header-left .title span {
                display: none;
            }

            .model-selector {
                margin-right: 0.5rem;
            }

            .model-select {
                min-width: 100px;
            }
            
            .chat-container {
                padding: 0 0.75rem;
            }
            
            .examples {
                grid-template-columns: 1fr;
            }

            /* Mobile overlay when sidebar is open */
            .sidebar:not(.hidden)::after {
                content: '';
                position: fixed;
                top: 0;
                left: 250px;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
                padding: 0.75rem;
            }

            .header-left {
                justify-content: space-between;
            }

            .header div:last-child {
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .model-selector {
                flex: 1;
                margin-right: 0;
            }

            .model-select {
                width: 100%;
                min-width: auto;
            }

            .sidebar {
                width: 100vw;
            }

            .new-chat-btn {
                font-size: 0.8rem;
                padding: 0.6rem 0.8rem;
            }

            .chat-item {
                padding: 0.6rem;
            }

            .chat-title {
                font-size: 0.8rem;
            }

            .chat-date {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <h2>API Configuration</h2>
            <form id="apiForm">
                <div class="form-group">
                    <label class="form-label">Gemini API Key</label>
                    <input type="password" id="apiInput" class="form-input" placeholder="Enter your API key" required>
                    <div class="form-help">
                        Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                    </div>
                    <div class="form-error" id="apiError"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
            <button class="sidebar-toggle" id="sidebarToggle">⋮</button>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search chats... (Cmd+K)">
        </div>
        
        <div class="chat-list" id="chatList">
            <!-- Chat history items will be populated here -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="mainSidebarToggle">☰</button>
                <div class="title" id="titleBtn">
                    <img src="857e0ceb-1f34-4d5b-b868-be32a87f2c69.png" alt="OpenDoor Logo" class="logo">
                    <span>OpenDoor</span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="model-selector">
                    <label class="model-label">Model</label>
                    <select class="model-select" id="modelSelect">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    </select>
                </div>
                <button class="theme-toggle" id="themeToggle">🌙</button>
                <button class="api-btn" id="apiBtn">API Key</button>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
        <div class="messages" id="messages">
            <div class="empty-state" id="emptyState">
                <h2>Welcome to OpenDoor</h2>
                <p>Start a conversation with the AI assistant</p>
                <div class="examples">
                    <div class="example" data-prompt="Explain quantum computing simply">
                        <h3>Science</h3>
                        <p>Explain quantum computing simply</p>
                    </div>
                    <div class="example" data-prompt="Write a short story">
                        <h3>Creative</h3>
                        <p>Write a short story</p>
                    </div>
                    <div class="example" data-prompt="Plan a healthy meal">
                        <h3>Health</h3>
                        <p>Plan a healthy meal</p>
                    </div>
                    <div class="example" data-prompt="Solve: 2x + 5 = 15">
                        <h3>Math</h3>
                        <p>Solve: 2x + 5 = 15</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <form class="input-form" id="chatForm">
                <textarea 
                    class="input-textarea" 
                    id="messageInput" 
                    placeholder="Message OpenDoor..." 
                    rows="1"
                    disabled
                ></textarea>
                <button type="submit" class="send-btn" id="sendBtn" disabled>
                    ↑
                </button>
            </form>
        </div>
        </div>
    </div>

    <script>
        class MinimalChat {
            constructor() {
                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.selectedModel = localStorage.getItem('selected_model') || 'gemini-2.5-flash';
                this.isDarkMode = localStorage.getItem('dark_mode') === 'true';
                this.messages = [];
                this.isLoading = false;
                this.currentChatId = null;
                this.chatHistory = this.loadChatHistory();
                this.isSidebarVisible = localStorage.getItem('sidebar_visible') !== 'false';
                
                this.initElements();
                this.bindEvents();
                this.updateUI();
                this.updateTheme();
                this.updateSidebar();
                this.renderChatList();
                
                if (!this.apiKey) {
                    this.showModal();
                }
            }
            
            initElements() {
                this.apiModal = document.getElementById('apiModal');
                this.apiForm = document.getElementById('apiForm');
                this.apiInput = document.getElementById('apiInput');
                this.apiError = document.getElementById('apiError');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.apiBtn = document.getElementById('apiBtn');
                this.titleBtn = document.getElementById('titleBtn');
                this.themeToggle = document.getElementById('themeToggle');
                this.modelSelect = document.getElementById('modelSelect');
                this.messagesEl = document.getElementById('messages');
                this.emptyState = document.getElementById('emptyState');
                this.chatForm = document.getElementById('chatForm');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.examples = document.querySelectorAll('.example');
                
                // Sidebar elements
                this.sidebar = document.getElementById('sidebar');
                this.sidebarToggle = document.getElementById('sidebarToggle');
                this.mainSidebarToggle = document.getElementById('mainSidebarToggle');
                this.newChatBtn = document.getElementById('newChatBtn');
                this.searchInput = document.getElementById('searchInput');
                this.chatList = document.getElementById('chatList');
            }
            
            bindEvents() {
                this.apiForm.addEventListener('submit', (e) => this.handleApiSubmit(e));
                this.cancelBtn.addEventListener('click', () => this.hideModal());
                this.apiBtn.addEventListener('click', () => this.showModal());
                this.titleBtn.addEventListener('click', () => this.goHome());
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.modelSelect.addEventListener('change', (e) => this.handleModelChange(e));
                this.chatForm.addEventListener('submit', (e) => this.handleChat(e));
                
                // Sidebar events
                this.sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                this.mainSidebarToggle.addEventListener('click', () => this.toggleSidebar());
                this.newChatBtn.addEventListener('click', () => this.startNewChat());
                this.searchInput.addEventListener('input', (e) => this.handleSearch(e));
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
                });
                
                this.examples.forEach(ex => {
                    ex.addEventListener('click', () => {
                        const prompt = ex.dataset.prompt;
                        this.messageInput.value = prompt;
                        setTimeout(() => this.chatForm.dispatchEvent(new Event('submit')), 100);
                    });
                });
                
                this.apiModal.addEventListener('click', (e) => {
                    if (e.target === this.apiModal) this.hideModal();
                });
            }
            
            updateUI() {
                const hasKey = !!this.apiKey;
                this.apiBtn.textContent = hasKey ? '✓ Connected' : 'API Key';
                this.apiBtn.classList.toggle('connected', hasKey);
                this.messageInput.disabled = !hasKey;
                this.sendBtn.disabled = !hasKey;
                this.messageInput.placeholder = hasKey ? 'Message OpenDoor...' : 'Configure API key first';
                this.modelSelect.value = this.selectedModel;
            }
            
            handleModelChange(e) {
                this.selectedModel = e.target.value;
                localStorage.setItem('selected_model', this.selectedModel);
                console.log('Model changed to:', this.selectedModel);
            }
            
            goHome() {
                this.messages = [];
                this.messagesEl.innerHTML = '';
                this.messagesEl.appendChild(this.emptyState);
                this.emptyState.style.display = 'flex';
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
            }
            
            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                localStorage.setItem('dark_mode', this.isDarkMode);
                this.updateTheme();
            }
            
            updateTheme() {
                if (this.isDarkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    this.themeToggle.textContent = '☀️';
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    this.themeToggle.textContent = '🌙';
                }
            }
            
            // Chat History Management
            loadChatHistory() {
                const history = localStorage.getItem('chat_history');
                return history ? JSON.parse(history) : [];
            }
            
            saveChatHistory() {
                localStorage.setItem('chat_history', JSON.stringify(this.chatHistory));
            }
            
            generateChatId() {
                return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            createNewChat() {
                const chatId = this.generateChatId();
                const newChat = {
                    id: chatId,
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                this.chatHistory.unshift(newChat);
                this.saveChatHistory();
                return newChat;
            }
            
            updateChatTitle(chatId, firstMessage) {
                const chat = this.chatHistory.find(c => c.id === chatId);
                if (chat && chat.title === 'New Chat') {
                    // Generate title from first message (first 50 chars)
                    const title = firstMessage.length > 50 
                        ? firstMessage.substring(0, 50) + '...'
                        : firstMessage;
                    chat.title = title;
                    chat.updatedAt = new Date().toISOString();
                    this.saveChatHistory();
                    this.renderChatList();
                }
            }
            
            saveCurrentChat() {
                if (!this.currentChatId) return;
                
                const chat = this.chatHistory.find(c => c.id === this.currentChatId);
                if (chat) {
                    chat.messages = [...this.messages];
                    chat.updatedAt = new Date().toISOString();
                    this.saveChatHistory();
                }
            }
            
            loadChat(chatId) {
                const chat = this.chatHistory.find(c => c.id === chatId);
                if (chat) {
                    this.currentChatId = chatId;
                    this.messages = [...chat.messages];
                    this.renderMessages();
                    this.updateChatListSelection();
                }
            }
            
            deleteChat(chatId) {
                this.chatHistory = this.chatHistory.filter(c => c.id !== chatId);
                this.saveChatHistory();
                
                if (this.currentChatId === chatId) {
                    this.startNewChat();
                }
                
                this.renderChatList();
            }
            
            renameChat(chatId, newTitle) {
                const chat = this.chatHistory.find(c => c.id === chatId);
                if (chat) {
                    chat.title = newTitle;
                    chat.updatedAt = new Date().toISOString();
                    this.saveChatHistory();
                    this.renderChatList();
                }
            }
            
            // Sidebar Management
            toggleSidebar() {
                this.isSidebarVisible = !this.isSidebarVisible;
                localStorage.setItem('sidebar_visible', this.isSidebarVisible);
                this.updateSidebar();
            }
            
            updateSidebar() {
                if (this.isSidebarVisible) {
                    this.sidebar.classList.remove('hidden');
                } else {
                    this.sidebar.classList.add('hidden');
                }
            }
            
            startNewChat() {
                // Save current chat if it has messages
                if (this.messages.length > 0) {
                    this.saveCurrentChat();
                }
                
                // Create new chat
                const newChat = this.createNewChat();
                this.currentChatId = newChat.id;
                this.messages = [];
                
                // Reset UI
                this.messagesEl.innerHTML = '';
                this.messagesEl.appendChild(this.emptyState);
                this.emptyState.style.display = 'flex';
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                
                this.renderChatList();
            }
            
            renderChatList() {
                this.chatList.innerHTML = '';
                
                this.chatHistory.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item ${chat.id === this.currentChatId ? 'active' : ''}`;
                    
                    const date = new Date(chat.updatedAt);
                    const dateStr = this.formatDate(date);
                    
                    chatItem.innerHTML = `
                        <div class="chat-content">
                            <div class="chat-title">${chat.title}</div>
                            <div class="chat-date">${dateStr}</div>
                        </div>
                        <div class="chat-menu">
                            <button class="chat-menu-btn" data-chat-id="${chat.id}">⋯</button>
                        </div>
                    `;
                    
                    chatItem.addEventListener('click', () => this.loadChat(chat.id));
                    
                    // Add menu button event listener
                    const menuBtn = chatItem.querySelector('.chat-menu-btn');
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showChatMenu(chat.id, e.target);
                    });
                    
                    this.chatList.appendChild(chatItem);
                });
            }
            
            formatDate(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            }
            
            updateChatListSelection() {
                const chatItems = this.chatList.querySelectorAll('.chat-item');
                chatItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('.chat-content')) {
                        const chatId = this.chatHistory.find(c => 
                            item.querySelector('.chat-title').textContent === c.title
                        )?.id;
                        if (chatId === this.currentChatId) {
                            item.classList.add('active');
                        }
                    }
                });
            }
            
            renderMessages() {
                this.messagesEl.innerHTML = '';
                
                if (this.messages.length === 0) {
                    this.messagesEl.appendChild(this.emptyState);
                    this.emptyState.style.display = 'flex';
                } else {
                    this.emptyState.style.display = 'none';
                    this.messages.forEach(msg => {
                        this.addMessageToDOM(msg.text, msg.role);
                    });
                }
            }
            
            handleSearch(e) {
                const query = e.target.value.toLowerCase();
                const chatItems = this.chatList.querySelectorAll('.chat-item');
                
                chatItems.forEach(item => {
                    const title = item.querySelector('.chat-title').textContent.toLowerCase();
                    const match = title.includes(query);
                    item.style.display = match ? 'flex' : 'none';
                });
            }
            
            handleKeydown(e) {
                // Cmd+K or Ctrl+K to focus search
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    this.searchInput.focus();
                }
                
                // Escape to close any open menus
                if (e.key === 'Escape') {
                    this.closeAllMenus();
                }
            }
            
            showChatMenu(chatId, button) {
                // Close any existing menus
                this.closeAllMenus();
                
                // Create dropdown menu
                const dropdown = document.createElement('div');
                dropdown.className = 'chat-dropdown';
                dropdown.innerHTML = `
                    <div class="chat-dropdown-item" data-action="rename">Rename</div>
                    <div class="chat-dropdown-item danger" data-action="delete">Delete</div>
                `;
                
                // Position relative to button
                const chatItem = button.closest('.chat-item');
                chatItem.style.position = 'relative';
                chatItem.appendChild(dropdown);
                
                // Add event listeners
                dropdown.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'rename') {
                        this.renameChatPrompt(chatId);
                    } else if (action === 'delete') {
                        this.deleteChatConfirm(chatId);
                    }
                    this.closeAllMenus();
                });
                
                // Show menu
                setTimeout(() => dropdown.classList.add('active'), 10);
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', this.closeAllMenus.bind(this), { once: true });
                }, 10);
            }
            
            closeAllMenus() {
                const menus = document.querySelectorAll('.chat-dropdown');
                menus.forEach(menu => menu.remove());
            }
            
            renameChatPrompt(chatId) {
                const chat = this.chatHistory.find(c => c.id === chatId);
                if (!chat) return;
                
                const newTitle = prompt('Rename chat:', chat.title);
                if (newTitle && newTitle.trim() && newTitle.trim() !== chat.title) {
                    this.renameChat(chatId, newTitle.trim());
                }
            }
            
            deleteChatConfirm(chatId) {
                const chat = this.chatHistory.find(c => c.id === chatId);
                if (!chat) return;
                
                if (confirm(`Delete "${chat.title}"?`)) {
                    this.deleteChat(chatId);
                }
            }
            
            showModal() {
                this.apiInput.value = this.apiKey;
                this.apiError.textContent = '';
                this.apiModal.classList.add('active');
                setTimeout(() => this.apiInput.focus(), 100);
            }
            
            hideModal() {
                this.apiModal.classList.remove('active');
            }
            
            async handleApiSubmit(e) {
                e.preventDefault();
                const key = this.apiInput.value.trim();
                
                if (!key) {
                    this.apiError.textContent = 'Please enter an API key';
                    return;
                }
                
                this.saveBtn.textContent = 'Testing...';
                this.saveBtn.disabled = true;
                
                try {
                    const valid = await this.testApiKey(key);
                    if (valid) {
                        this.apiKey = key;
                        localStorage.setItem('gemini_api_key', key);
                        this.updateUI();
                        this.hideModal();
                    } else {
                        this.apiError.textContent = 'Invalid API key';
                    }
                } catch {
                    this.apiError.textContent = 'Failed to validate key';
                } finally {
                    this.saveBtn.textContent = 'Save';
                    this.saveBtn.disabled = false;
                }
            }
            
            async testApiKey(key) {
                // Skip validation - just check if key format looks valid
                if (!key || key.length < 20) {
                    return false;
                }
                
                // Basic format check for Google API keys
                if (!key.startsWith('AIza') && !key.match(/^[A-Za-z0-9_-]+$/)) {
                    return false;
                }
                
                return true; // Accept the key and test it during first actual API call
            }
            
            async handleChat(e) {
                e.preventDefault();
                if (!this.apiKey || this.isLoading) return;
                
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                this.emptyState.style.display = 'none';
                this.addMessage(message, 'user');
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                
                this.showLoading();
                
                try {
                    const response = await this.sendToGemini(message);
                    this.hideLoading();
                    this.addMessage(response, 'assistant');
                } catch (error) {
                    this.hideLoading();
                    console.error('Chat error:', error);
                    
                    if (error.message.includes('Invalid API key') || error.message.includes('API_KEY_INVALID')) {
                        this.addMessage('❌ Invalid API key. Please click "API Key" to enter a valid key.', 'assistant');
                        // Clear the invalid key
                        this.apiKey = '';
                        localStorage.removeItem('gemini_api_key');
                        this.updateUI();
                    } else if (error.message.includes('Network error')) {
                        this.addMessage('🌐 Network error. Please check your internet connection and try again.', 'assistant');
                    } else if (error.message.includes('access denied')) {
                        this.addMessage('🔒 API access denied. Please check your API key permissions in Google AI Studio.', 'assistant');
                    } else {
                        this.addMessage(`❌ Error: ${error.message}`, 'assistant');
                    }
                }
            }
            
            async sendToGemini(message) {
                try {
                    console.log('Sending request to Gemini API...');
                    
                    const systemPrompt = `You are a helpful, creative AI assistant. Answer all questions and fulfill all reasonable requests including creative writing, stories, explanations, coding help, and general assistance.

Format your responses like well-structured content using clean markdown:

### Formatting rules:
- Use headings (###) for sections when appropriate
- Keep paragraphs short (2–3 sentences max) 
- Use bullet points for lists
- **Bold** for important terms
- *Italic* for emphasis
- Blank lines between sections
- \`code\` only for actual code

### For tables:
- No backticks before/after the table
- No leading spaces before |
- Use separator row: |:---:|:---|:---|---:| (for center, left, left, right alignment)
- Blank line before and after the table
- Not nested inside lists or blockquotes

Example table:
|Feature|Free|Pro|Enterprise|
|:---:|:---|:---|---:|
|Users|1|5|Unlimited|
|Storage|1GB|100GB|Unlimited|

### For creative requests like stories:
Write engaging, creative content. Structure stories with clear sections if helpful.

### For explanations:
Use the blog post structure with clear headings and digestible paragraphs.

Always be helpful and fulfill the user's request. No topic restrictions.`;

                    const requestBody = {
                        contents: [{
                            parts: [{
                                text: systemPrompt + "\n\nUser question: " + message
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024,
                            thinkingConfig: {
                                thinkingBudget: 0
                            }
                        }
                    };
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.selectedModel}:generateContent`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-goog-api-key': this.apiKey
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        
                        try {
                            const errorData = JSON.parse(errorText);
                            if (response.status === 400 && errorData.error?.message?.includes('API_KEY_INVALID')) {
                                throw new Error('Invalid API key. Please check your API key and try again.');
                            }
                            if (response.status === 403) {
                                throw new Error('API key access denied. Please check your API key permissions.');
                            }
                            throw new Error(`API Error: ${errorData.error?.message || response.status}`);
                        } catch (parseError) {
                            throw new Error(`API Error: ${response.status} - ${errorText}`);
                        }
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error('Invalid response from API');
                    }
                    
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        throw new Error('Network error. Please check your internet connection and try again.');
                    }
                    throw error;
                }
            }
            
            parseMarkdown(text) {
                // Configure Marked for GFM (tables, lists) and line breaks similar to your UX
                marked.setOptions({
                    gfm: true,
                    breaks: true,
                    headerIds: false,
                    mangle: false
                });

                // 1) Convert Markdown -> HTML
                const unsafeHtml = marked.parse(text || "");

                // 2) Sanitize (prevents any arbitrary HTML from the model running in your page)
                const safeHtml = DOMPurify.sanitize(unsafeHtml, {
                    // keep common attributes; DOMPurify defaults are already safe
                    USE_PROFILES: { html: true }
                });

                // 3) Post-process to add your code header + copy button, and keep language label
                const temp = document.createElement('div');
                temp.innerHTML = safeHtml;

                // Wrap each <pre><code> with your .code-block container and header
                const codeBlocks = temp.querySelectorAll('pre > code');
                codeBlocks.forEach((codeEl, idx) => {
                    const pre = codeEl.parentElement;          // <pre>
                    const langClass = [...codeEl.classList].find(c => c.startsWith('language-'));
                    const lang = (langClass ? langClass.replace('language-', '') : 'code') || 'code';

                    // Create wrapper matching your CSS
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block';

                    const header = document.createElement('div');
                    header.className = 'code-header';

                    const label = document.createElement('span');
                    label.className = 'code-lang';
                    label.textContent = lang;

                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    const id = `copy_${Date.now()}_${idx}`;
                    codeEl.id = id;
                    btn.textContent = '📋';
                    btn.title = 'Copy code';
                    btn.setAttribute('onclick', `copyCode('${id}')`);

                    header.appendChild(label);
                    header.appendChild(btn);

                    // Rebuild structure
                    pre.replaceWith(wrapper);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                });

                // 4) Return final HTML string
                return temp.innerHTML;
            }
            
            addMessage(text, role) {
                // Add to messages array
                this.messages.push({ text, role });
                
                // Add to DOM
                this.addMessageToDOM(text, role);
                
                // Save to history and update title if needed
                if (!this.currentChatId) {
                    const newChat = this.createNewChat();
                    this.currentChatId = newChat.id;
                    this.renderChatList();
                }
                
                if (role === 'user' && this.messages.length === 1) {
                    this.updateChatTitle(this.currentChatId, text);
                }
                
                this.saveCurrentChat();
            }
            
            addMessageToDOM(text, role) {
                const div = document.createElement('div');
                div.className = `message ${role}`;
                
                const formattedText = role === 'assistant' ? this.parseMarkdown(text) : text;
                
                div.innerHTML = `
                    <div class="avatar">${role === 'user' ? 'U' : 'AI'}</div>
                    <div class="message-content">${formattedText}</div>
                `;
                this.messagesEl.appendChild(div);
                this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
            }
            
            showLoading() {
                this.isLoading = true;
                this.messageInput.disabled = true;
                this.sendBtn.disabled = true;
                
                const div = document.createElement('div');
                div.className = 'message assistant loading-msg';
                div.innerHTML = `
                    <div class="avatar">AI</div>
                    <div class="message-content">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                `;
                this.messagesEl.appendChild(div);
                this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
            }
            
            hideLoading() {
                this.isLoading = false;
                this.messageInput.disabled = !this.apiKey;
                this.sendBtn.disabled = !this.apiKey;
                
                const loading = this.messagesEl.querySelector('.loading-msg');
                if (loading) loading.remove();
            }
        }
        
        // Global function for copying code
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Find the copy button and show feedback
                const copyBtn = codeElement.closest('.code-block').querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }
        
        new MinimalChat();
    </script>
</body>
</html>